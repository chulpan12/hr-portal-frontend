<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamofEnC - Blog</title>
    <link rel="stylesheet" href="../../assets/blog.css">
</head>
<body>

    <div class="container">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <h1 class="page-title">HRì§€ì›ì‹¤ AI/ìë™í™” í™œìš©ì‹¤ì </h1>

        <!-- ë¸”ë¡œê·¸ ê¸€ ëª©ë¡ì´ í‘œì‹œë  ì˜ì—­ -->
        <div id="post-list-view">
            <div id="post-list-container" class="post-list">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í¬ìŠ¤íŠ¸ ì¹´ë“œê°€ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </div>
        </div>

        <!-- ë¸”ë¡œê·¸ ê¸€ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë  ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="post-detail-view" style="display: none;">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í¬ìŠ¤íŠ¸ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
        </div>
        
        <!-- í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
        <a href="../../index.html" class="back-button" style="margin-right: 10px;">í™ˆìœ¼ë¡œ</a>
        
        <!-- ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ (ëª©ë¡ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <a href="editor.html" id="new-post-button" class="back-button" style="margin-right: 10px;">ìƒˆ ê¸€ ì‘ì„±</a>

        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ìƒì„¸ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <button id="history-back" class="back-button" style="display: none; margin-right: 10px;">ë’¤ë¡œê°€ê¸°</button>
        
        <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ (ìƒì„¸ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <button id="back-to-list" class="back-button" style="display: none;">ëª©ë¡ìœ¼ë¡œ</button>

    </div>

    <!-- ë¸”ë¡œê·¸ ë°ì´í„° ë° ë Œë”ë§ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postListContainer = document.getElementById('post-list-container');
            const postListView = document.getElementById('post-list-view');
            const postDetailView = document.getElementById('post-detail-view');
            const backToListButton = document.getElementById('back-to-list');
            const newPostButton = document.getElementById('new-post-button');
            const historyBackButton = document.getElementById('history-back');

            // --- API ì„¤ì • ---
            // ì‹¤ì œ ë°°í¬ëœ ë°±ì—”ë“œ API ì£¼ì†Œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
            // ì˜ˆ: https://api.dreamofenc.com
            // ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ: http://127.0.0.1:8000
            const API_BASE_URL = 'https://api.dreamofenc.com'; 

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            const renderContent = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');

                if (postId) {
                    fetchPostDetail(postId);
                } else {
                    fetchPostList();
                }
            };
            
            // APIë¡œë¶€í„° ê²Œì‹œë¬¼ ëª©ë¡ì„ ê°€ì ¸ì™€ í‘œì‹œ
            const fetchPostList = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const posts = await response.json();

                    displayPostList(posts);
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    const errorPost = {
                        title: 'ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨',
                        date: new Date().toLocaleDateString(),
                        author: 'ì‹œìŠ¤í…œ',
                        content: 'ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
                    };
                    displayPostList([errorPost]); // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê²Œì‹œë¬¼ í˜•íƒœë¡œ í‘œì‹œ
                }
            };

            // HTML ë¬¸ìì—´ì—ì„œ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œí•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë§Œë“œëŠ” í—¬í¼ í•¨ìˆ˜
            const createTextPreview = (htmlString, maxLength) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                if (text.length > maxLength) {
                    return text.substring(0, maxLength) + '...';
                }
                return text;
            };

            // ê²Œì‹œë¬¼ ëª©ë¡ í‘œì‹œ
            const displayPostList = (posts) => {
                postListView.style.display = 'block';
                postDetailView.style.display = 'none';
                backToListButton.style.display = 'none';
                historyBackButton.style.display = 'none';
                newPostButton.style.display = 'inline-block';

                postListContainer.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    
                    // HTML íƒœê·¸ë¥¼ ì œì™¸í•œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                    const postContentPreview = createTextPreview(post.content, 150);

                    postCard.innerHTML = `
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-meta">
                            ${post.date} by ${post.author}
                            <span style="float: right; opacity: 0.7;">ğŸ‘ï¸ ${post.views || 0}</span>
                        </p>
                        <div class="post-content">${postContentPreview}</div>
                    `;
                    postCard.addEventListener('click', () => {
                        window.location.href = `?id=${post.id}`;
                    });
                    postListContainer.appendChild(postCard);
                });
            };

            // APIë¡œë¶€í„° íŠ¹ì • ê²Œì‹œë¬¼ì„ ê°€ì ¸ì™€ í‘œì‹œ
            const fetchPostDetail = async (id) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${id}`);
                    if (!response.ok) throw new Error('Post not found');
                    const post = await response.json();
                    
                    displayPostDetail(post);
                } catch (error) {
                    console.error('Error fetching post detail:', error);
                    postDetailView.innerHTML = `<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                }
            };

            // ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ìš© í‘œì‹œ
            const displayPostDetail = (post) => {
                postListView.style.display = 'none';
                postDetailView.style.display = 'block';
                backToListButton.style.display = 'inline-block';
                historyBackButton.style.display = 'inline-block';
                newPostButton.style.display = 'none';

                postDetailView.innerHTML = `
                    <h2 class="post-title">${post.title}</h2>
                    <p class="post-meta">
                        ${post.date} by ${post.author}
                        <span style="float: right; opacity: 0.7;">ğŸ‘ï¸ ${post.views || 0}</span>
                    </p>
                    <div class="post-content">${post.content}</div>
                    <button class="back-button" onclick="location.href='editor.html?id=${post.id}'" style="margin-top: 20px;">ìˆ˜ì •í•˜ê¸°</button>
                    
                    <hr style="margin: 40px 0 30px; border-color: #333;">

                    <div id="comments-section">
                        <h3 style="margin-bottom: 20px;">ëŒ“ê¸€</h3>
                        <div id="comments-list"></div>
                        <form id="comment-form" style="margin-top: 20px;">
                            <textarea id="comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="width: 100%; min-height: 80px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; padding: 10px; box-sizing: border-box; font-family: inherit;"></textarea>
                            <button type="submit" class="back-button" style="margin-top: 10px;">ëŒ“ê¸€ ì‘ì„±</button>
                        </form>
                    </div>
                `;

                // ëŒ“ê¸€ ê¸°ëŠ¥ ì´ˆê¸°í™”
                displayComments(post.comments || []);
                document.getElementById('comment-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleCommentSubmit(post.id);
                });
            };

            // --- Start: New Comment Functions ---
            const displayComments = (comments) => {
                const commentsListEl = document.getElementById('comments-list');
                if (!commentsListEl) return;

                commentsListEl.innerHTML = '';
                if (comments.length === 0) {
                    commentsListEl.innerHTML = '<p style="opacity: 0.7;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
                    return;
                }

                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-item';
                    commentEl.style.marginBottom = '20px';
                    commentEl.innerHTML = `
                        <p style="margin: 0 0 5px; font-weight: bold;">${comment.author} <span style="font-weight: normal; opacity: 0.7; font-size: 0.9em;">- ${new Date(comment.date).toLocaleString()}</span></p>
                        <p style="margin: 0; padding-left: 5px; border-left: 2px solid #444;">${comment.content.replace(/\n/g, '<br>')}</p>
                    `;
                    commentsListEl.appendChild(commentEl);
                });
            };

            const handleCommentSubmit = async (postId) => {
                const contentTextarea = document.getElementById('comment-content');
                const content = contentTextarea.value.trim();
                if (!content) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            author: 'ìµëª…', // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë¡œê·¸ì¸ ì—°ë™ í•„ìš”
                            content: content,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    // ëŒ“ê¸€ ì‘ì„± ì„±ê³µ í›„, ì „ì²´ ê²Œì‹œë¬¼ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
                    // (ì‹¤ì‹œê°„ìœ¼ë¡œ ëŒ“ê¸€ì´ ì¶”ê°€ëœ ê²ƒì„ ë°˜ì˜í•˜ê¸° ìœ„í•¨)
                    fetchPostDetail(postId);

                } catch (error) {
                    console.error('Error submitting comment:', error);
                    alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
            // --- End: New Comment Functions ---

            // 'ëª©ë¡ìœ¼ë¡œ' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            backToListButton.addEventListener('click', () => {
                window.location.href = 'blog.html';
            });

            // 'ë’¤ë¡œê°€ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            historyBackButton.addEventListener('click', () => {
                history.back();
            });

            renderContent();
        });
    </script>

</body>
</html> 