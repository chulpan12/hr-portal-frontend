<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamofEnC - Blog</title>
    <link rel="stylesheet" href="../../assets/blog.css">
</head>
<body>

    <div class="container">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <h1 class="page-title">HRì§€ì›ì‹¤ AI/ìë™í™” í™œìš©ì‹¤ì </h1>

        <!-- ë¸”ë¡œê·¸ ê¸€ ëª©ë¡ì´ í‘œì‹œë  ì˜ì—­ -->
        <div id="post-list-view">
            <div id="post-list-container" class="post-list">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í¬ìŠ¤íŠ¸ ì¹´ë“œê°€ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </div>
        </div>

        <!-- ë¸”ë¡œê·¸ ê¸€ ìƒì„¸ ë‚´ìš©ì´ í‘œì‹œë  ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="post-detail-view" style="display: none;">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í¬ìŠ¤íŠ¸ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
        </div>
        
        <!-- í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
        <a href="../../index.html" class="back-button home" style="margin-right: 10px;">í™ˆìœ¼ë¡œ</a>
        
        <!-- ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ (ëª©ë¡ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <a href="editor_login.html" id="new-post-button" class="back-button" style="margin-right: 10px;">ìƒˆ ê¸€ ì‘ì„±</a>

        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ìƒì„¸ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <button id="history-back" class="back-button history" style="display: none; margin-right: 10px;">ë’¤ë¡œê°€ê¸°</button>
        
        <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ (ìƒì„¸ë³´ê¸°ì—ë§Œ í‘œì‹œë¨) -->
        <button id="back-to-list" class="back-button" style="display: none;">ëª©ë¡ìœ¼ë¡œ</button>

    </div>

    <!-- ë¸”ë¡œê·¸ ë°ì´í„° ë° ë Œë”ë§ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postListContainer = document.getElementById('post-list-container');
            const postListView = document.getElementById('post-list-view');
            const postDetailView = document.getElementById('post-detail-view');
            const backToListButton = document.getElementById('back-to-list');
            const newPostButton = document.getElementById('new-post-button');
            const historyBackButton = document.getElementById('history-back');

            const API_BASE_URL = 'https://api.dreamofenc.com'; 
            let postListCache = []; // ëª¨ë“  í¬ìŠ¤íŠ¸ ëª©ë¡ì„ ìºì‹œí•  ë³€ìˆ˜

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë  ë©”ì¸ í•¨ìˆ˜
            const renderContent = async () => {
                // 1. í•­ìƒ ì „ì²´ í¬ìŠ¤íŠ¸ ëª©ë¡ì„ ê°€ì ¸ì™€ ìºì‹œì— ì €ì¥í•©ë‹ˆë‹¤.
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    postListCache = await response.json();
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    postListContainer.innerHTML = '<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                    return; // ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
                }

                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');

                // 2. postIdê°€ ìˆìœ¼ë©´ ìƒì„¸ ë³´ê¸°, ì—†ìœ¼ë©´ ëª©ë¡ ë³´ê¸°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
                if (postId) {
                    // ìƒì„¸ë³´ê¸°ë¥¼ ìœ„í•´ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ ë“±)
                    fetchPostDetail(postId);
                } else {
                    displayPostList(postListCache);
                }
            };
            
            // ê²Œì‹œë¬¼ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
            const displayPostList = (posts) => {
                postListView.style.display = 'block';
                postDetailView.style.display = 'none';
                backToListButton.style.display = 'none';
                historyBackButton.style.display = 'none';
                newPostButton.style.display = 'inline-block';

                postListContainer.innerHTML = '';
                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    const postContentPreview = createTextPreview(post.content, 150);
                    postCard.innerHTML = `
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-meta">
                            ${post.date} by ${post.author}
                            <span style="float: right; opacity: 0.7;">ğŸ‘ï¸ ${post.views || 0}</span>
                        </p>
                        <div class="post-content">${postContentPreview}</div>
                    `;
                    postCard.addEventListener('click', () => {
                        history.pushState({ id: post.id }, '', `?id=${post.id}`);
                        fetchPostDetail(post.id);
                    });
                    postListContainer.appendChild(postCard);
                });
            };

            // APIë¡œë¶€í„° íŠ¹ì • ê²Œì‹œë¬¼ì„ ê°€ì ¸ì™€ í‘œì‹œ
            const fetchPostDetail = async (id) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${id}`);
                    if (!response.ok) throw new Error('Post not found');
                    const post = await response.json();
                    displayPostDetail(post);
                } catch (error) {
                    console.error('Error fetching post detail:', error);
                    postDetailView.innerHTML = `<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                }
            };
            
            // í—¬í¼ í•¨ìˆ˜ (HTML -> Text)
            const createTextPreview = (htmlString, maxLength) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            };

            // ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ìš© í‘œì‹œ
            const displayPostDetail = (post) => {
                postListView.style.display = 'none';
                postDetailView.style.display = 'block';
                backToListButton.style.display = 'inline-block';
                historyBackButton.style.display = 'inline-block';
                newPostButton.style.display = 'none';

                // --- ì´ì „/ë‹¤ìŒ ê¸€ ì°¾ê¸° ---
                const currentIndex = postListCache.findIndex(p => p.id === post.id);
                const prevPost = currentIndex > 0 ? postListCache[currentIndex - 1] : null;
                const nextPost = currentIndex < postListCache.length - 1 ? postListCache[currentIndex + 1] : null;

                const prevButton = prevPost 
                    ? `<a href="?id=${prevPost.id}" class="nav-button prev-button" data-nav-id="${prevPost.id}">&lt; ì´ì „ ê¸€</a>` 
                    : `<span class="nav-button disabled">&lt; ì´ì „ ê¸€</span>`;
                const nextButton = nextPost 
                    ? `<a href="?id=${nextPost.id}" class="nav-button next-button" data-nav-id="${nextPost.id}">ë‹¤ìŒ ê¸€ &gt;</a>` 
                    : `<span class="nav-button disabled">ë‹¤ìŒ ê¸€ &gt;</span>`;

                postDetailView.innerHTML = `
                    <div class="post-navigation">
                        ${prevButton}
                        ${nextButton}
                    </div>
                    <h2 class="post-title">${post.title}</h2>
                    <p class="post-meta">
                        ${post.date} by ${post.author}
                        <span style="float: right; opacity: 0.7;">ğŸ‘ï¸ ${post.views || 0}</span>
                    </p>
                    <div class="post-content">${post.content}</div>
                    <button class="back-button" onclick="location.href='editor_login.html?id=${post.id}'" style="margin-top: 20px;">ìˆ˜ì •í•˜ê¸°</button>
                    
                    <hr style="margin: 40px 0 30px; border-color: #333;">

                    <div id="comments-section">
                        <h3 style="margin-bottom: 20px;">ëŒ“ê¸€</h3>
                        <div id="comments-list"></div>
                        <form id="comment-form" style="margin-top: 20px;">
                            <div class="comment-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="comment-author" placeholder="ì‘ì„±ì" required style="flex: 1; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px;">
                                <input type="password" id="comment-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required style="flex: 1; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px;">
                            </div>
                            <textarea id="comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="width: 100%; min-height: 80px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; padding: 10px; box-sizing: border-box; font-family: inherit;"></textarea>
                            <button type="submit" class="back-button" style="margin-top: 10px;">ëŒ“ê¸€ ì‘ì„±</button>
                        </form>
                    </div>
                `;

                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
                postDetailView.querySelectorAll('.nav-button[data-nav-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const navId = e.target.dataset.navId;
                        history.pushState({ id: navId }, '', `?id=${navId}`);
                        fetchPostDetail(navId);
                    });
                });
                
                // ëŒ“ê¸€ ê¸°ëŠ¥ ì´ˆê¸°í™”
                displayComments(post.id, post.comments || []);
                document.getElementById('comment-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleCommentSubmit(post.id);
                });
            };
            
            // --- Start: New Comment Functions ---
            const displayComments = (postId, comments) => {
                const commentsListEl = document.getElementById('comments-list');
                if (!commentsListEl) return;

                commentsListEl.innerHTML = '';
                if (comments.length === 0) {
                    commentsListEl.innerHTML = '<p style="opacity: 0.7;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
                    return;
                }

                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-item';
                    commentEl.style.marginBottom = '20px';
                    commentEl.id = `comment-${comment.id}`; // ê° ëŒ“ê¸€ì— ê³ ìœ  ID ë¶€ì—¬
                    commentEl.innerHTML = `
                        <div class="comment-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <p style="margin: 0; font-weight: bold;">
                                ${comment.author} 
                                <span style="font-weight: normal; opacity: 0.7; font-size: 0.9em;">- ${new Date(comment.date).toLocaleString()}</span>
                            </p>
                            <div>
                                <button class="comment-action-btn" data-action="edit" data-comment-id="${comment.id}">ìˆ˜ì •</button>
                                <button class="comment-action-btn" data-action="delete" data-comment-id="${comment.id}">ì‚­ì œ</button>
                            </div>
                        </div>
                        <p class="comment-content" style="margin: 0; padding-left: 5px; border-left: 2px solid #444;">${comment.content.replace(/\n/g, '<br>')}</p>
                    `;
                    commentsListEl.appendChild(commentEl);
                });

                // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                commentsListEl.querySelectorAll('.comment-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        const commentId = e.target.dataset.commentId;
                        if (action === 'edit') {
                            promptEditComment(postId, commentId);
                        } else if (action === 'delete') {
                            handleCommentDelete(postId, commentId);
                        }
                    });
                });
            };

            const handleCommentSubmit = async (postId) => {
                const authorInput = document.getElementById('comment-author');
                const passwordInput = document.getElementById('comment-password');
                const contentTextarea = document.getElementById('comment-content');
                
                const author = authorInput.value.trim();
                const password = passwordInput.value.trim();
                const content = contentTextarea.value.trim();

                if (!author || !password || !content) {
                    alert('ì‘ì„±ì, ë¹„ë°€ë²ˆí˜¸, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ author, password, content }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    // ëŒ“ê¸€ ì‘ì„± ì„±ê³µ í›„, í¼ ì´ˆê¸°í™” ë° ê²Œì‹œë¬¼ ìƒˆë¡œê³ ì¹¨
                    authorInput.value = '';
                    passwordInput.value = '';
                    contentTextarea.value = '';
                    fetchPostDetail(postId);

                } catch (error) {
                    console.error('Error submitting comment:', error);
                    alert(`ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            };
            
            // ëŒ“ê¸€ ìˆ˜ì •ì„ ìœ„í•œ ì…ë ¥ í¼ì„ ë„ìš°ëŠ” í•¨ìˆ˜
            const promptEditComment = (postId, commentId) => {
                const commentEl = document.getElementById(`comment-${commentId}`);
                const contentEl = commentEl.querySelector('.comment-content');
                const originalContent = contentEl.innerHTML.replace(/<br\s*\/?>/gi, '\n'); // HTML -> text

                const editForm = document.createElement('div');
                editForm.className = 'comment-edit-form';
                editForm.innerHTML = `
                    <textarea style="width: 100%; min-height: 80px; margin-bottom: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; padding: 10px; box-sizing: border-box;">${originalContent}</textarea>
                    <input type="password" placeholder="ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required style="width: 100%; margin-bottom: 10px; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; box-sizing: border-box;">
                    <button class="save-btn back-button" style="margin-right: 5px;">ì €ì¥</button>
                    <button class="cancel-btn back-button">ì·¨ì†Œ</button>
                `;
                
                commentEl.replaceChild(editForm, contentEl);

                editForm.querySelector('.save-btn').addEventListener('click', async () => {
                    const newContent = editForm.querySelector('textarea').value;
                    const password = editForm.querySelector('input[type="password"]').value;
                    await handleCommentEdit(postId, commentId, newContent, password);
                });
                
                editForm.querySelector('.cancel-btn').addEventListener('click', () => {
                    fetchPostDetail(postId); // ê°„ë‹¨í•˜ê²Œ ì „ì²´ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³µì›
                });
            };

            // ëŒ“ê¸€ ìˆ˜ì • APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
            const handleCommentEdit = async (postId, commentId, newContent, password) => {
                if (!password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${postId}/comments/${commentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newContent, password: password }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    fetchPostDetail(postId); // ì„±ê³µ ì‹œ ê²Œì‹œë¬¼ ìƒˆë¡œê³ ì¹¨

                } catch (error) {
                    console.error('Error editing comment:', error);
                    alert(`ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            };

            // ëŒ“ê¸€ ì‚­ì œë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
            const handleCommentDelete = async (postId, commentId) => {
                const password = prompt('ëŒ“ê¸€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                if (password === null) return; // ì‚¬ìš©ìê°€ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥¸ ê²½ìš°
                if (!password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${postId}/comments/${commentId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    fetchPostDetail(postId); // ì„±ê³µ ì‹œ ê²Œì‹œë¬¼ ìƒˆë¡œê³ ì¹¨

                } catch (error) {
                    console.error('Error deleting comment:', error);
                    alert(`ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            };
            // --- End: New Comment Functions ---

            // 'ëª©ë¡ìœ¼ë¡œ' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            backToListButton.addEventListener('click', () => {
                history.pushState(null, '', 'blog.html');
                displayPostList(postListCache);
            });

            // 'ë’¤ë¡œê°€ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            historyBackButton.addEventListener('click', () => {
                history.back();
            });
            
            // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
            window.addEventListener('popstate', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');
                if (postId) {
                    fetchPostDetail(postId);
                } else {
                    displayPostList(postListCache);
                }
            });

            // ì´ˆê¸° ë Œë”ë§ ì‹œì‘
            renderContent();
        });
    </script>

    <style>
        /* í™”ë©´ ë„ˆë¹„ê°€ 480px ì´í•˜ì¼ ë•Œ ì ìš©ë  ìŠ¤íƒ€ì¼ */
        @media (max-width: 480px) {
            .comment-input-group {
                flex-direction: column; /* ì•„ì´í…œë“¤ì„ ì„¸ë¡œë¡œ ìŒ“ìŒ */
            }
        }
    </style>

</body>
</html> 