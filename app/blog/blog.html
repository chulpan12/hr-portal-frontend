<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamofEnC - Blog</title>
    <link rel="stylesheet" href="../../assets/blog.css?v=2.1">
</head>
<body>
    <div class="container">
        <h1 class="page-title">AI/ìë™í™” í™œìš©ì‹¤ì </h1>

        <main class="content-area">
            <div id="post-list-view"></div>
            <div id="post-detail-view" style="display: none;"></div>
        </main>
        
        <div id="detail-actions">
            <button id="history-back" class="action-button" style="display: none;">ë’¤ë¡œê°€ê¸°</button>
            <button id="back-to-list" class="action-button" style="display: none;">ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>

    <div class="fab-container">
        <a href="../../index.html" class="fab" title="í™ˆìœ¼ë¡œ">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
        </a>
        <a href="editor_login.html" id="new-post-button" class="fab" title="ìƒˆ ê¸€ ì‘ì„±">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </a>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const postListView = document.getElementById('post-list-view');
        const postDetailView = document.getElementById('post-detail-view');
        
        // buttonContainer ë³€ìˆ˜ëŠ” ë” ì´ìƒ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
        const backToListButton = document.getElementById('back-to-list');
        const newPostButton = document.getElementById('new-post-button');
        const historyBackButton = document.getElementById('history-back');

        const API_BASE_URL = 'https://api.dreamofenc.com'; 
        let postListCache = [];

        // --- START: ì‡¼ì¼€ì´ìŠ¤ ê´€ë ¨ ë¡œì§ ---
        let currentIndex = 0;

        const displayShowcaseList = (posts) => {
            postListView.style.display = 'flex'; // block -> flexë¡œ ë³€ê²½
            postDetailView.style.display = 'none';
            
            // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì œì–´
            newPostButton.style.display = 'flex'; // inline-block -> flexë¡œ ë³€ê²½
            historyBackButton.style.display = 'none';
            backToListButton.style.display = 'none';

            postListView.innerHTML = `
                <div id="showcase-container" class="showcase-container">
                    <div id="showcase-wrapper" class="showcase-wrapper"></div>
                    <button id="nav-prev" class="showcase-nav prev">&lt;</button>
                    <button id="nav-next" class="showcase-nav next">&gt;</button>
                </div>
            `;
            
            const showcaseWrapper = document.getElementById('showcase-wrapper');
            if (!posts || posts.length === 0) {
                showcaseWrapper.innerHTML = '<p class="no-posts">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            posts.forEach((post, index) => {
                const card = document.createElement('div');
                card.className = 'showcase-card';
                card.dataset.index = index;

                const imgMatch = post.content.match(/<img[^>]+src="([^">]+)"/);
                const imageHtml = imgMatch ? `<img src="${imgMatch[1]}" alt="${post.title} ì´ë¯¸ì§€" class="card-image">` : '<div class="card-image-placeholder"></div>';

                card.innerHTML = `
                    ${imageHtml}
                    <div class="card-content">
                        <h2 class="card-title">${post.title}</h2>
                        <p class="card-meta">${post.date} by ${post.author} | ğŸ‘ï¸ ${post.views || 0}</p>
                        <p class="card-preview">${createTextPreview(post.content, 100)}</p>
                        <button class="card-readmore-btn">ìì„¸íˆ ë³´ê¸° &rarr;</button>
                    </div>
                `;
                
                card.querySelector('.card-readmore-btn').addEventListener('click', () => {
                    history.pushState({ id: post.id }, '', `?id=${post.id}`);
                    fetchPostDetail(post.id);
                });

                showcaseWrapper.appendChild(card);
            });
            
            const renderShowcase = () => {
                const cards = showcaseWrapper.children;
                if (!cards.length) return;
                
                for (let i = 0; i < cards.length; i++) {
                    cards[i].classList.remove('active', 'prev', 'next', 'hidden');
                    if (i === currentIndex) cards[i].classList.add('active');
                    else if (i === (currentIndex - 1 + cards.length) % cards.length) cards[i].classList.add('prev');
                    else if (i === (currentIndex + 1) % cards.length) cards[i].classList.add('next');
                    else cards[i].classList.add('hidden');
                }

                // ë¬´í•œ ìºëŸ¬ì…€ì„ ìœ„í•´ ë¹„í™œì„±í™” ë¡œì§ì„ ê°„ë‹¨í•˜ê²Œ ìˆ˜ì •
                // document.getElementById('nav-prev').disabled = currentIndex === 0;
                // document.getElementById('nav-next').disabled = currentIndex === posts.length - 1;
            };
            
            document.getElementById('nav-prev').addEventListener('click', () => { 
                currentIndex = (currentIndex - 1 + posts.length) % posts.length; 
                renderShowcase(); 
            });
            document.getElementById('nav-next').addEventListener('click', () => { 
                currentIndex = (currentIndex + 1) % posts.length;
                renderShowcase(); 
            });
            
            renderShowcase();
        };
        // --- END: ì‡¼ì¼€ì´ìŠ¤ ê´€ë ¨ ë¡œì§ ---

        // --- START: ê¸°ì¡´ ìƒì„¸/ëŒ“ê¸€ ë¡œì§ (ì¼ë¶€ ìˆ˜ì •) ---
        const fetchPostDetail = async (id) => {
             try {
                const response = await fetch(`${API_BASE_URL}/api/blog/posts/${id}`);
                if (!response.ok) throw new Error('Post not found');
                const post = await response.json();
                displayPostDetail(post);
            } catch (error) {
                postDetailView.innerHTML = `<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        };

        const displayPostDetail = (post) => {
            postListView.style.display = 'none';
            postDetailView.style.display = 'block';
            backToListButton.style.display = 'inline-block';
            historyBackButton.style.display = 'inline-block';
            newPostButton.style.display = 'none';

            const currentIndex = postListCache.findIndex(p => p.id === post.id);
            const prevPost = currentIndex > 0 ? postListCache[currentIndex - 1] : null;
            const nextPost = currentIndex < postListCache.length - 1 ? postListCache[currentIndex + 1] : null;

            const prevButton = prevPost ? `<a href="?id=${prevPost.id}" class="nav-button prev-button" data-nav-id="${prevPost.id}">&lt; ì´ì „ ê¸€</a>` : `<span class="nav-button disabled">&lt; ì´ì „ ê¸€</span>`;
            const nextButton = nextPost ? `<a href="?id=${nextPost.id}" class="nav-button next-button" data-nav-id="${nextPost.id}">ë‹¤ìŒ ê¸€ &gt;</a>` : `<span class="nav-button disabled">ë‹¤ìŒ ê¸€ &gt;</span>`;

            // 'ìˆ˜ì •í•˜ê¸°' ë²„íŠ¼ì— ìƒˆë¡œìš´ `action-button` í´ë˜ìŠ¤ ì ìš©
            postDetailView.innerHTML = `
                <div class="post-navigation">${prevButton}${nextButton}</div>
                <h2 class="post-title">${post.title}</h2>
                <p class="post-meta">${post.date} by ${post.author}<span style="float: right; opacity: 0.7;">ğŸ‘ï¸ ${post.views || 0}</span></p>
                <div class="post-content">${post.content}</div>
                <button class="action-button edit-button" onclick="location.href='editor_login.html?id=${post.id}'">ìˆ˜ì •í•˜ê¸°</button>
                <hr style="margin: 40px 0 30px; border-color: #333;">
                <div id="comments-section">
                    <h3 style="margin-bottom: 20px;">ëŒ“ê¸€</h3>
                    <div id="comments-list"></div>
                    <form id="comment-form" style="margin-top: 20px;">
                        <div class="comment-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="comment-author" placeholder="ì‘ì„±ì" required style="flex: 1; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px;"><input type="password" id="comment-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required style="flex: 1; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px;"></div>
                        <textarea id="comment-content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="width: 100%; min-height: 80px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; padding: 10px; box-sizing: border-box; font-family: inherit;"></textarea>
                        <button type="submit" class="action-button" style="margin-top: 10px;">ëŒ“ê¸€ ì‘ì„±</button>
                    </form>
                </div>`;
            
            postDetailView.querySelectorAll('.nav-button[data-nav-id]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const navId = e.target.dataset.navId;
                    history.pushState({ id: navId }, '', `?id=${navId}`);
                    fetchPostDetail(navId);
                });
            });
            // (ì´í•˜ ëŒ“ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ)
        };
        const createTextPreview = (htmlString, maxLength) => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            const text = tempDiv.textContent || tempDiv.innerText || "";
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        };
        // --- END: ê¸°ì¡´ ìƒì„¸/ëŒ“ê¸€ ë¡œì§ ---
        
        // --- START: ë©”ì¸ ë¡œì§ ---
        const renderContent = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/blog/posts`);
                if (!response.ok) throw new Error('Network response was not ok');
                postListCache = await response.json();
            } catch (error) {
                postListView.innerHTML = '<p>ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            if (postId) {
                fetchPostDetail(postId);
            } else {
                displayShowcaseList(postListCache);
            }
        };

        backToListButton.addEventListener('click', () => {
            history.pushState(null, '', 'blog.html');
            displayShowcaseList(postListCache);
        });

        historyBackButton.addEventListener('click', () => history.back());
        
        window.addEventListener('popstate', (event) => {
            // popstate ì´ë²¤íŠ¸ ë°œìƒ ì‹œ IDë¥¼ í™•ì¸í•˜ì—¬ ì ì ˆí•œ í•¨ìˆ˜ í˜¸ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            if (postId) {
                fetchPostDetail(postId);
            } else {
                displayShowcaseList(postListCache);
            }
        });

        renderContent();
    });
    </script>
</body>
</html>