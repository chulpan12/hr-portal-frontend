<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamofEnC - Blog</title>
    <link rel="stylesheet" href="../../assets/blog.css">
</head>
<body>

    <div class="container">
        <!-- 페이지 타이틀 -->
        <h1 class="page-title">HR지원실 AI/자동화 활용실적</h1>

        <!-- 블로그 글 목록이 표시될 영역 -->
        <div id="post-list-view">
            <div id="post-list-container" class="post-list">
                <!-- 자바스크립트로 포스트 카드가 여기에 채워집니다. -->
            </div>
        </div>

        <!-- 블로그 글 상세 내용이 표시될 영역 (초기에는 숨김) -->
        <div id="post-detail-view" style="display: none;">
            <!-- 자바스크립트로 포스트 상세 내용이 여기에 채워집니다. -->
        </div>
        
        <!-- 홈으로 돌아가기 버튼 -->
        <a href="../../index.html" class="back-button" style="margin-right: 10px;">홈으로</a>
        
        <!-- 새 글 작성 버튼 (목록보기에만 표시됨) -->
        <a href="editor.html" id="new-post-button" class="back-button" style="margin-right: 10px;">새 글 작성</a>

        <!-- 뒤로가기 버튼 (상세보기에만 표시됨) -->
        <button id="history-back" class="back-button" style="display: none; margin-right: 10px;">뒤로가기</button>
        
        <!-- 목록으로 돌아가기 버튼 (상세보기에만 표시됨) -->
        <button id="back-to-list" class="back-button" style="display: none;">목록으로</button>

    </div>

    <!-- 블로그 데이터 및 렌더링 스크립트 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postListContainer = document.getElementById('post-list-container');
            const postListView = document.getElementById('post-list-view');
            const postDetailView = document.getElementById('post-detail-view');
            const backToListButton = document.getElementById('back-to-list');
            const newPostButton = document.getElementById('new-post-button');
            const historyBackButton = document.getElementById('history-back');

            // --- API 설정 ---
            // 실제 배포된 백엔드 API 주소를 사용해야 합니다.
            // 예: https://api.dreamofenc.com
            // 로컬 테스트 시: http://127.0.0.1:8000
            const API_BASE_URL = 'https://api.dreamofenc.com'; 

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');

            const renderContent = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');

                if (postId) {
                    fetchPostDetail(postId);
                } else {
                    fetchPostList();
                }
            };
            
            // API로부터 게시물 목록을 가져와 표시
            const fetchPostList = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const posts = await response.json();

                    displayPostList(posts);
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    const errorPost = {
                        title: '게시물 불러오기 실패',
                        date: new Date().toLocaleDateString(),
                        author: '시스템',
                        content: '게시물을 불러오는 데 실패했습니다.'
                    };
                    displayPostList([errorPost]); // 에러 메시지를 게시물 형태로 표시
                }
            };

            // HTML 문자열에서 텍스트만 추출하여 미리보기를 만드는 헬퍼 함수
            const createTextPreview = (htmlString, maxLength) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                const text = tempDiv.textContent || tempDiv.innerText || "";
                if (text.length > maxLength) {
                    return text.substring(0, maxLength) + '...';
                }
                return text;
            };

            // 게시물 목록 표시
            const displayPostList = (posts) => {
                postListView.style.display = 'block';
                postDetailView.style.display = 'none';
                backToListButton.style.display = 'none';
                historyBackButton.style.display = 'none';
                newPostButton.style.display = 'inline-block';

                postListContainer.innerHTML = ''; // 기존 목록 초기화
                posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    
                    // HTML 태그를 제외한 순수 텍스트로 미리보기를 생성합니다.
                    const postContentPreview = createTextPreview(post.content, 150);

                    postCard.innerHTML = `
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-meta">
                            ${post.date} by ${post.author}
                            <span style="float: right; opacity: 0.7;">👁️ ${post.views || 0}</span>
                        </p>
                        <div class="post-content">${postContentPreview}</div>
                    `;
                    postCard.addEventListener('click', () => {
                        window.location.href = `?id=${post.id}`;
                    });
                    postListContainer.appendChild(postCard);
                });
            };

            // API로부터 특정 게시물을 가져와 표시
            const fetchPostDetail = async (id) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${id}`);
                    if (!response.ok) throw new Error('Post not found');
                    const post = await response.json();
                    
                    displayPostDetail(post);
                } catch (error) {
                    console.error('Error fetching post detail:', error);
                    postDetailView.innerHTML = `<p>게시물을 불러오는 데 실패했습니다.</p>`;
                }
            };

            // 게시물 상세 내용 표시
            const displayPostDetail = (post) => {
                postListView.style.display = 'none';
                postDetailView.style.display = 'block';
                backToListButton.style.display = 'inline-block';
                historyBackButton.style.display = 'inline-block';
                newPostButton.style.display = 'none';

                postDetailView.innerHTML = `
                    <h2 class="post-title">${post.title}</h2>
                    <p class="post-meta">
                        ${post.date} by ${post.author}
                        <span style="float: right; opacity: 0.7;">👁️ ${post.views || 0}</span>
                    </p>
                    <div class="post-content">${post.content}</div>
                    <button class="back-button" onclick="location.href='editor.html?id=${post.id}'" style="margin-top: 20px;">수정하기</button>
                    
                    <hr style="margin: 40px 0 30px; border-color: #333;">

                    <div id="comments-section">
                        <h3 style="margin-bottom: 20px;">댓글</h3>
                        <div id="comments-list"></div>
                        <form id="comment-form" style="margin-top: 20px;">
                            <textarea id="comment-content" placeholder="댓글을 입력하세요..." required style="width: 100%; min-height: 80px; background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px; padding: 10px; box-sizing: border-box; font-family: inherit;"></textarea>
                            <button type="submit" class="back-button" style="margin-top: 10px;">댓글 작성</button>
                        </form>
                    </div>
                `;

                // 댓글 기능 초기화
                displayComments(post.comments || []);
                document.getElementById('comment-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleCommentSubmit(post.id);
                });
            };

            // --- Start: New Comment Functions ---
            const displayComments = (comments) => {
                const commentsListEl = document.getElementById('comments-list');
                if (!commentsListEl) return;

                commentsListEl.innerHTML = '';
                if (comments.length === 0) {
                    commentsListEl.innerHTML = '<p style="opacity: 0.7;">아직 댓글이 없습니다. 첫 댓글을 남겨보세요!</p>';
                    return;
                }

                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-item';
                    commentEl.style.marginBottom = '20px';
                    commentEl.innerHTML = `
                        <p style="margin: 0 0 5px; font-weight: bold;">${comment.author} <span style="font-weight: normal; opacity: 0.7; font-size: 0.9em;">- ${new Date(comment.date).toLocaleString()}</span></p>
                        <p style="margin: 0; padding-left: 5px; border-left: 2px solid #444;">${comment.content.replace(/\n/g, '<br>')}</p>
                    `;
                    commentsListEl.appendChild(commentEl);
                });
            };

            const handleCommentSubmit = async (postId) => {
                const contentTextarea = document.getElementById('comment-content');
                const content = contentTextarea.value.trim();
                if (!content) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/blog/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            author: '익명', // 실제 서비스에서는 로그인 연동 필요
                            content: content,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error('댓글 작성에 실패했습니다.');
                    }

                    // 댓글 작성 성공 후, 전체 게시물 데이터를 다시 불러와 화면을 갱신합니다.
                    // (실시간으로 댓글이 추가된 것을 반영하기 위함)
                    fetchPostDetail(postId);

                } catch (error) {
                    console.error('Error submitting comment:', error);
                    alert('댓글 작성 중 오류가 발생했습니다.');
                }
            };
            // --- End: New Comment Functions ---

            // '목록으로' 버튼 이벤트 리스너
            backToListButton.addEventListener('click', () => {
                window.location.href = 'blog.html';
            });

            // '뒤로가기' 버튼 이벤트 리스너
            historyBackButton.addEventListener('click', () => {
                history.back();
            });

            renderContent();
        });
    </script>

</body>
</html> 