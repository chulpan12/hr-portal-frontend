<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Learning Insight Hub - L.U.N.A.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./assets/css/style.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .glass-card {
      background: rgba(15, 18, 25, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 116, 139, 0.2);
    }
    .kpi-card {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
    }
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .chart-container {
      position: relative;
      height: 280px;
    }
    .top-learner-row {
      transition: background 0.2s;
    }
    .top-learner-row:hover {
      background: rgba(51, 65, 85, 0.4);
    }
  </style>
</head>
<body class="bg-[#0B0E14] text-slate-200 min-h-screen flex flex-col font-sans">

  <!-- 배경 효과 -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-emerald-500 rounded-full blur-[150px] opacity-10"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-500 rounded-full blur-[150px] opacity-10"></div>
    <div class="absolute top-1/2 right-1/3 w-64 h-64 bg-purple-500 rounded-full blur-[120px] opacity-5"></div>
  </div>

  <!-- 헤더 -->
  <header class="flex items-center justify-between px-6 py-4 bg-[#0f1219]/80 border-b border-slate-800 shrink-0 z-20">
    <div class="flex items-center gap-4">
      <!-- L.U.N.A. Brand Identity Block -->
      <a href="index.html" class="flex items-center gap-3 select-none cursor-pointer group">
        <!-- Neural Core Icon (Refined & Balanced) -->
        <div class="relative w-10 h-10 flex items-center justify-center">
          <!-- Ambient Background Glow -->
          <div class="absolute inset-0 bg-cyan-500/20 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
          <!-- Orbit Ring 1 (Solid, Slow Rotate) -->
          <div class="absolute inset-0 rounded-full border border-cyan-500/30 group-hover:border-cyan-400/60 transition-colors duration-500 animate-[spin_10s_linear_infinite]"></div>
          <!-- Orbit Ring 2 (Dashed, Counter Rotate) -->
          <div class="absolute w-[130%] h-[130%] rounded-full border border-dashed border-cyan-500/10 animate-[spin_20s_linear_infinite_reverse]"></div>
          <!-- Orbiting Electron (Fast Spin) -->
          <div class="absolute w-full h-full animate-[spin_3s_linear_infinite] group-hover:animate-[spin_1.5s_linear_infinite]">
            <div class="w-1.5 h-1.5 bg-cyan-300 rounded-full absolute -top-0.5 left-1/2 -translate-x-1/2 shadow-[0_0_10px_#22d3ee]"></div>
          </div>
          <!-- Inner Core (Floating & Breathing) -->
          <div class="relative w-5 h-5 rounded-full bg-gradient-to-tr from-cyan-600 to-cyan-300 shadow-lg shadow-cyan-500/30 z-10 group-hover:scale-110 group-hover:shadow-cyan-400/60 transition-all duration-500 animate-[float_3s_ease-in-out_infinite]">
            <div class="absolute inset-0 bg-white/40 rounded-full animate-pulse"></div>
          </div>
        </div>
        <!-- Typography Lockup (Visual Balance Logic) -->
        <div class="flex flex-col justify-center h-full">
          <h1 class="text-xl font-bold leading-none tracking-[0.2em] -mr-[0.2em]" style="font-family: 'Space Mono', monospace;">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-100 via-white to-cyan-400 group-hover:from-white group-hover:to-cyan-300 transition-all duration-300">LUNA</span>
          </h1>
          <!-- Decorative Divider Line (Expands on hover) -->
          <div class="w-full h-px bg-gradient-to-r from-cyan-500/50 via-cyan-500/20 to-transparent my-1 origin-left scale-x-50 group-hover:scale-x-100 transition-transform duration-500 ease-out"></div>
          <span class="text-[8px] text-cyan-500/60 tracking-[0.12em] font-medium leading-none uppercase group-hover:text-cyan-400 transition-colors duration-300 whitespace-nowrap" style="font-family: 'JetBrains Mono', monospace;">
            Logic Unified Neural Advisor
          </span>
        </div>
      </a>
      <div class="w-px h-8 bg-slate-700"></div>
      <div>
        <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
          <i class="fas fa-chart-bar text-emerald-400"></i>Learning Insight Hub
        </h1>
        <p class="text-xs text-slate-500">관리자 전용 학습 분석 대시보드</p>
      </div>
    </div>
    
    <div class="flex items-center gap-3">
      <span id="admin-badge" class="hidden text-xs px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded-full">
        <i class="fas fa-shield-alt mr-1"></i>관리자
      </span>
      <a href="admin.html" class="text-sm text-purple-400 hover:text-purple-300 transition-colors px-3 py-2 rounded hover:bg-slate-800">
        <i class="fas fa-cog mr-1"></i>관리자 페이지
      </a>
      <a href="index.html" class="text-sm text-slate-400 hover:text-white transition-colors px-3 py-2 rounded hover:bg-slate-800">
        <i class="fas fa-home mr-1"></i>홈으로
      </a>
    </div>
  </header>

  <!-- 메인 컨텐츠 -->
  <main class="flex-1 relative z-10 overflow-y-auto">
    <div class="max-w-6xl mx-auto px-6 py-8">
      
      <!-- 로딩 상태 -->
      <div id="loading-container" class="flex flex-col items-center justify-center py-20">
        <div class="w-16 h-16 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin mb-4"></div>
        <p class="text-slate-400">분석 데이터를 불러오는 중...</p>
      </div>
      
      <!-- 에러 상태 -->
      <div id="error-container" class="hidden">
        <div class="glass-card rounded-xl p-8 text-center">
          <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
          <h3 class="text-lg font-semibold text-white mb-2">데이터를 불러올 수 없습니다</h3>
          <p id="error-message" class="text-slate-400 mb-4">관리자 권한이 필요합니다.</p>
          <div class="flex justify-center gap-3">
            <button onclick="loadAnalytics()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white text-sm transition-colors">
              <i class="fas fa-redo mr-1"></i>다시 시도
            </button>
            <a href="admin.html" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white text-sm transition-colors">
              <i class="fas fa-arrow-left mr-1"></i>관리자 페이지로
            </a>
          </div>
        </div>
      </div>
      
      <!-- 분석 컨텐츠 -->
      <div id="analytics-content" class="hidden space-y-6">
        
        <!-- KPI 카드 섹션 -->
        <section>
          <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-tachometer-alt text-emerald-400"></i>
            핵심 지표 (KPI)
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- 총 사용자 -->
            <div class="kpi-card glass-card rounded-xl p-5">
              <div class="flex items-center gap-4">
                <div class="kpi-icon bg-gradient-to-br from-cyan-500/20 to-blue-500/20 text-cyan-400">
                  <i class="fas fa-users"></i>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase tracking-wider">총 사용자</p>
                  <p class="text-2xl font-bold text-white" id="kpi-total-users">0</p>
                </div>
              </div>
            </div>
            
            <!-- 오늘 활동 사용자 (DAU) -->
            <div class="kpi-card glass-card rounded-xl p-5">
              <div class="flex items-center gap-4">
                <div class="kpi-icon bg-gradient-to-br from-emerald-500/20 to-teal-500/20 text-emerald-400">
                  <i class="fas fa-user-clock"></i>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase tracking-wider">오늘 활동</p>
                  <p class="text-2xl font-bold text-white" id="kpi-active-today">0</p>
                </div>
              </div>
            </div>
            
            <!-- 총 XP -->
            <div class="kpi-card glass-card rounded-xl p-5">
              <div class="flex items-center gap-4">
                <div class="kpi-icon bg-gradient-to-br from-amber-500/20 to-orange-500/20 text-amber-400">
                  <i class="fas fa-star"></i>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase tracking-wider">총 XP</p>
                  <p class="text-2xl font-bold text-white" id="kpi-total-xp">0</p>
                </div>
              </div>
            </div>
            
            <!-- 총 레슨 수 -->
            <div class="kpi-card glass-card rounded-xl p-5">
              <div class="flex items-center gap-4">
                <div class="kpi-icon bg-gradient-to-br from-purple-500/20 to-indigo-500/20 text-purple-400">
                  <i class="fas fa-book-open"></i>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase tracking-wider">총 레슨</p>
                  <p class="text-2xl font-bold text-white" id="kpi-total-lessons">0</p>
                </div>
              </div>
            </div>
          </div>
        </section>
        
        <!-- 차트 섹션 -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- XP 추이 차트 -->
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-md font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fas fa-chart-line text-amber-400"></i>
              일별 XP 획득 추이 (최근 7일)
            </h3>
            <div class="chart-container">
              <canvas id="xp-chart"></canvas>
            </div>
          </div>
          
          <!-- DAU 차트 -->
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-md font-semibold text-white mb-4 flex items-center gap-2">
              <i class="fas fa-chart-bar text-emerald-400"></i>
              일별 활성 사용자 (DAU)
            </h3>
            <div class="chart-container">
              <canvas id="dau-chart"></canvas>
            </div>
          </div>
        </section>
        
        <!-- Top 5 학습자 섹션 -->
        <section class="glass-card rounded-xl overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-700/50 flex items-center justify-between">
            <h3 class="text-md font-semibold text-white flex items-center gap-2">
              <i class="fas fa-trophy text-amber-400"></i>
              Top 5 학습자
            </h3>
            <a href="leaderboard.html" class="text-xs text-cyan-400 hover:text-cyan-300 transition-colors">
              전체 랭킹 보기 <i class="fas fa-chevron-right ml-1"></i>
            </a>
          </div>
          
          <div id="top-learners-list" class="divide-y divide-slate-800/50">
            <!-- 동적으로 추가됨 -->
          </div>
          
          <!-- 빈 상태 -->
          <div id="empty-learners" class="hidden py-8 text-center text-slate-500">
            <i class="fas fa-user-graduate text-3xl mb-2 opacity-50"></i>
            <p>아직 학습 기록이 있는 사용자가 없습니다.</p>
          </div>
        </section>
        
        <!-- 마지막 업데이트 시간 -->
        <div class="text-center text-xs text-slate-500">
          <i class="fas fa-sync-alt mr-1"></i>
          마지막 업데이트: <span id="last-updated">-</span>
        </div>
        
      </div>
    </div>
  </main>

  <script type="module">
    import { getJSON } from './assets/js/config.js';
    
    let analyticsData = null;
    let xpChart = null;
    let dauChart = null;
    
    // 페이지 로드 시 분석 데이터 불러오기
    document.addEventListener('DOMContentLoaded', () => {
      loadAnalytics();
    });
    
    // 분석 데이터 로드
    async function loadAnalytics() {
      showLoading(true);
      hideError();
      
      try {
        analyticsData = await getJSON('/admin/analytics');
        renderAnalytics();
        showContent();
        document.getElementById('admin-badge').classList.remove('hidden');
      } catch (error) {
        console.error('[Analytics] 로드 실패:', error);
        showError(error.message);
      }
    }
    
    // 분석 데이터 렌더링
    function renderAnalytics() {
      if (!analyticsData) return;
      
      // API 응답: { kpi: {...}, chart: { labels, dau, xp }, top_learners: [...] }
      const { kpi, chart, top_learners } = analyticsData;
      
      // KPI 렌더링
      renderKPI(kpi);
      
      // 차트 렌더링
      renderCharts(chart);
      
      // Top 5 학습자 렌더링
      renderTopLearners(top_learners);
      
      // 업데이트 시간
      document.getElementById('last-updated').textContent = new Date().toLocaleString('ko-KR');
    }
    
    // KPI 렌더링
    function renderKPI(kpi) {
      document.getElementById('kpi-total-users').textContent = (kpi.total_users || 0).toLocaleString();
      document.getElementById('kpi-active-today').textContent = (kpi.active_today || 0).toLocaleString();
      document.getElementById('kpi-total-xp').textContent = (kpi.total_xp || 0).toLocaleString();
      document.getElementById('kpi-total-lessons').textContent = (kpi.total_lessons || 0).toLocaleString();
    }
    
    // 차트 렌더링
    function renderCharts(chart) {
      // API 응답: { labels: [], dau: [], xp: [] }
      const { labels, dau, xp } = chart;
      
      // 공통 차트 옵션
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(100, 116, 139, 0.1)'
            },
            ticks: {
              color: '#94a3b8',
              font: { size: 11 }
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(100, 116, 139, 0.1)'
            },
            ticks: {
              color: '#94a3b8',
              font: { size: 11 }
            }
          }
        }
      };
      
      // XP 추이 차트 (Line)
      const xpCtx = document.getElementById('xp-chart').getContext('2d');
      if (xpChart) xpChart.destroy();
      
      xpChart = new Chart(xpCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'XP 획득',
            data: xp,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#f59e0b',
            pointBorderColor: '#fff',
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: commonOptions
      });
      
      // DAU 차트 (Bar)
      const dauCtx = document.getElementById('dau-chart').getContext('2d');
      if (dauChart) dauChart.destroy();
      
      dauChart = new Chart(dauCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '활성 사용자',
            data: dau,
            backgroundColor: 'rgba(16, 185, 129, 0.6)',
            borderColor: '#10b981',
            borderWidth: 1,
            borderRadius: 4,
            barThickness: 30
          }]
        },
        options: commonOptions
      });
    }
    
    // Top 5 학습자 렌더링
    function renderTopLearners(learners) {
      const listEl = document.getElementById('top-learners-list');
      const emptyEl = document.getElementById('empty-learners');
      
      if (!learners || learners.length === 0) {
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }
      
      emptyEl.classList.add('hidden');
      
      const medalColors = ['text-amber-400', 'text-slate-400', 'text-orange-400', 'text-slate-500', 'text-slate-500'];
      const medalIcons = ['fa-crown', 'fa-medal', 'fa-medal', 'fa-award', 'fa-award'];
      
      listEl.innerHTML = learners.map((user, index) => {
        const rank = index + 1;
        return `
          <div class="top-learner-row flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-4">
              <div class="w-8 h-8 rounded-full flex items-center justify-center ${index < 3 ? 'bg-amber-500/10' : 'bg-slate-800'}">
                <i class="fas ${medalIcons[index]} ${medalColors[index]}"></i>
              </div>
              <div>
                <div class="font-medium text-white">${user.name || user.username}</div>
                <div class="text-xs text-slate-500">@${user.username}</div>
              </div>
            </div>
            <div class="flex items-center gap-6">
              <div class="text-right">
                <div class="text-amber-400 font-semibold">${user.xp.toLocaleString()}</div>
                <div class="text-xs text-slate-500">XP</div>
              </div>
              <div class="text-right">
                <div class="text-purple-400 font-semibold">Lv.${user.level}</div>
                <div class="text-xs text-slate-500">레벨</div>
              </div>
              <div class="text-right">
                <div class="text-cyan-400 font-semibold">${user.streak_days || 0}</div>
                <div class="text-xs text-slate-500">연속일</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // UI 헬퍼 함수들
    function showLoading(show) {
      document.getElementById('loading-container').classList.toggle('hidden', !show);
    }
    
    function showContent() {
      showLoading(false);
      document.getElementById('analytics-content').classList.remove('hidden');
    }
    
    function showError(message) {
      showLoading(false);
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-container').classList.remove('hidden');
    }
    
    function hideError() {
      document.getElementById('error-container').classList.add('hidden');
    }
    
    // 전역으로 내보내기 (retry 버튼용)
    window.loadAnalytics = loadAnalytics;
  </script>
</body>
</html>
